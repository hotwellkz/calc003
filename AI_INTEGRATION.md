# Интеграция AI-чата в калькулятор SIP-домов

## Обзор

В проект добавлен AI-чат на базе OpenAI, который позволяет пользователям описывать дом обычным языком, а ИИ задаёт уточняющие вопросы и рассчитывает стоимость, используя существующую логику калькулятора.

## Структура изменений

### Frontend

1. **`src/services/sipCalculator.ts`** - Сервис с функцией `calculateSipCost`, обёртывающей существующую логику расчёта
2. **`src/components/calculator/ChatPanel.tsx`** - UI компонент чата
3. **`src/pages/Calculator.tsx`** - Добавлен ChatPanel на страницу калькулятора

### Backend

1. **`backend/server.js`** - Express сервер
2. **`backend/routes/aiCalculator.js`** - Endpoint `/api/ai/calculator-chat` с OpenAI integration
3. **`backend/services/sipCalculator.js`** - Логика расчёта для backend (копия frontend логики)
4. **`backend/data/`** - Данные калькулятора (цены, опции и т.д.)
5. **`backend/config/pricing.js`** - Конфигурация цен

## Установка и настройка

### 1. Backend

```bash
cd backend
npm install
```

Создайте файл `backend/.env`:

```env
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4o-mini
PORT=3001
FRONTEND_URL=http://localhost:5173
```

Запустите backend:

```bash
npm run dev
```

### 2. Frontend

Создайте файл `.env` в корне проекта:

```env
VITE_API_BASE_URL=http://localhost:3001
```

Или если backend на другом сервере:

```env
VITE_API_BASE_URL=https://api.yourdomain.com
```

Запустите frontend:

```bash
npm run dev
```

## Как это работает

1. **Пользователь описывает дом** в чате (например: "Хочу одноэтажный дом 80 м² в Алматы")
2. **AI задаёт уточняющие вопросы** если не хватает параметров (тип фундамента, крыши и т.д.)
3. **Когда параметров достаточно**, AI вызывает функцию `calculate_sip_house_cost` через tool calling
4. **Backend выполняет расчёт** используя существующую логику из `calculatePrice`
5. **AI получает результат** и красиво объясняет его пользователю

## Важные моменты

### ✅ Все расчёты выполняются существующим калькулятором

- AI **НЕ придумывает** цены
- Все суммы рассчитываются функцией `calculateSipCost` / `calculatePrice`
- Формулы и логика остаются неизменными

### ✅ Системный промпт

AI настроен как дружелюбный консультант, который:
- Задаёт уточняющие вопросы
- Всегда вызывает функцию для расчёта
- Объясняет результаты простым языком
- Форматирует цифры с пробелами (8 426 300 ₸)

### ✅ Обработка ошибок

- Если OpenAI недоступен - показывается мягкое сообщение
- Если параметры неверные - AI попросит уточнить
- Frontend обрабатывает ошибки сети

## Тестирование

### Сценарии для проверки:

1. **Простой запрос:**
   ```
   "Хочу одноэтажный дом 80 м² в Алматы"
   ```

2. **Запрос с уточнениями:**
   ```
   "Сделайте расчёт двухэтажного дома 150 м² с ЖБ лентой"
   ```

3. **Запрос с рассрочкой:**
   ```
   "Нужен дом под ключ с рассрочкой"
   ```

4. **Неполный запрос:**
   ```
   "Хочу дом"
   ```
   AI должен задать уточняющие вопросы

## Проверка совпадения расчётов

Чтобы убедиться, что чат и форма дают одинаковые результаты:

1. Задайте параметры в AI-чате и получите расчёт
2. Введите те же параметры в форму калькулятора
3. Сравните итоговые суммы - они должны совпадать

## Конфигурация модели

По умолчанию используется `gpt-4o-mini` (быстрая и дешёвая модель).

Для более качественных ответов можно использовать:
- `gpt-4o` - более качественные ответы, но дороже
- `gpt-4-turbo` - баланс качества и скорости

Измените в `backend/.env`:
```env
OPENAI_MODEL=gpt-4o
```

## Производственное развёртывание

1. **Backend:**
   - Установите переменные окружения на сервере
   - Запустите через PM2 или systemd
   - Настройте reverse proxy (nginx) если нужно

2. **Frontend:**
   - Укажите `VITE_API_BASE_URL` в production build
   - Пересоберите проект: `npm run build`

## Безопасность

- API ключ OpenAI хранится только на backend
- CORS настроен для разрешённых доменов
- Валидация входных данных на backend
- Обработка ошибок без раскрытия внутренней логики

## Дальнейшие улучшения (опционально)

1. **Интеграция с формой:**
   - Кнопка "Заполнить из формы" в чате
   - Автозаполнение формы из чата

2. **История диалогов:**
   - Сохранение в localStorage
   - Экспорт диалога

3. **Улучшение UX:**
   - Голосовой ввод
   - Предложения быстрых ответов
   - Превью расчёта в реальном времени

